const fs = require('fs').promises;
const path = require('path');

app.post('/api/rutas', async (req, res) => {
    if (!db) {
        return res.status(500).json({
            success: false,
            message: "Error: No hay conexión a la base de datos."
        });
    }

    try {
        const { nombre, id, stop, rutaGeoJSON, paradasGeoJSON } = req.body;

        // Crear directorios si no existen
        const rutaDir = path.join(__dirname, 'data', id);
        await fs.mkdir(rutaDir, { recursive: true });

        // Guardar archivos GeoJSON
        await fs.writeFile(
            path.join(rutaDir, 'route.json'),
            JSON.stringify(rutaGeoJSON)
        );

        await fs.writeFile(
            path.join(rutaDir, `route_${stop}_stops.geojson`),
            JSON.stringify({
                type: "FeatureCollection",
                features: paradasGeoJSON
            })
        );

        // Guardar información en la base de datos
        const ruta = {
            id,
            name: nombre,
            stop,
            createdAt: new Date(),
            active: true
        };

        await db.collection('rutas').insertOne(ruta);

        res.json({
            success: true,
            message: "Ruta creada exitosamente"
        });

    } catch (error) {
        console.error("Error al crear ruta:", error);
        res.status(500).json({
            success: false,
            message: "Error al crear la ruta"
        });
    }
});